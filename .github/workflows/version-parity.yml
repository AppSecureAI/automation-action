name: Version parity

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to validate (optional for manual runs, e.g., v1.0.8)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  parity:
    name: Tag/package version parity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Resolve tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TAG="${GITHUB_REF_NAME}"
          elif [[ -n "${{ inputs.tag || '' }}" ]]; then
            TAG="${{ inputs.tag }}"
          else
            echo "::error::No tag available. For workflow_dispatch provide inputs.tag"
            exit 1
          fi

          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z.-]+)?$ ]]; then
            echo "::error::Tag must be SemVer with v-prefix. Got: $TAG"
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Validate package.json version
        shell: bash
        run: |
          set -euo pipefail
          TAG_VERSION="${{ steps.tag.outputs.version }}"
          PKG_VERSION="$(node -p \"require('./package.json').version\")"

          echo "Tag version: $TAG_VERSION"
          echo "Package version: $PKG_VERSION"

          if [[ "$TAG_VERSION" != "$PKG_VERSION" ]]; then
            echo "::error::Tag ${{ steps.tag.outputs.tag }} does not match package.json version $PKG_VERSION"
            exit 1
          fi
